---
title: "Batchr Demonstration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batchr Demonstration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Demonstration

Consider a temporary directory with the four txt files

```{r}
path <- file.path(tempdir(), "demo")
unlink(path)
dir.create(path)

writeLines("the contents of file.txt", file.path(path, "file.txt"))
writeLines("the contents of file2.txt", file.path(path, "file2.txt"))
writeLines("the contents of file3.txt", file.path(path, "file3.txt"))
writeLines("the contents of file4.txt", file.path(path, "file4.txt"))
```

and a function that would successfully process the first two files 
but fail for the last two by returning FALSE and throwing an error, respectively.

```{r}
fun <- function(file) {
  if(grepl("file3[.]txt$", file)) return(FALSE)
  if(grepl("file4[.]txt$", file)) stop("this is the error message", call. = FALSE)
  txt <- readLines(file)
  txt <- gsub("contents", "modified contents", txt)
  writeLines(txt, file)
}
```

### Configuration

First the user should configure the directory by providing a regular expression.
```{r}
library(batchr)



batch_config(fun, path = path, pattern = "^file\\d[.]csv$")
```

Configuring a directory creates a hidden file (``r batch_config_files(path)``) which can be read using `batch_read_config()`
```{r}
batch_config_files(path) # hidden file
batch_read_config(path)
```
The `time` value specifies the system time (in UTC) that the project was configured.
A file is only treated as unprocessed if the time it was last modified is *before* the time of configuration 
If a file is successfully processed its modification time is set to the current time; otherwise the name of the file is logged in the `.batchr.log` file.

### Start

The next task is to start (or restart) processing the files using `batch_start()`.
```{r}
batch_run(path, ask = FALSE)
```
