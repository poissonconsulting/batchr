---
title: "Batchr Demonstration"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Batchr Demonstration}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Demonstration

Consider a temporary directory with four txt files

```{r}
path <- file.path(tempdir(), "demo")
unlink(path)
dir.create(path)

writeLines("the contents of file.txt", file.path(path, "file.txt"))
writeLines("the contents of file2.txt", file.path(path, "file2.txt"))
writeLines("the contents of file3.txt", file.path(path, "file3.txt"))
writeLines("the contents of file4.txt", file.path(path, "file4.txt"))
```

and a function that will successfully process the first two files 
but fail for the last two by returning FALSE and throwing an error, respectively.

```{r}
fun <- function(file) {
  if(grepl("file3[.]txt$", file)) return(FALSE)
  if(grepl("file4[.]txt$", file)) stop("this is the error message", call. = FALSE)
  txt <- readLines(file)
  txt <- gsub("contents", "modified contents", txt)
  writeLines(txt, file)
}
```

### Configuration

Now let the user configure the directory to only process files names that include
a digit before the file extension.
```{r}
library(batchr)
print(batch_config(fun, path = path, regexp = "file\\d[.]txt$"))
```

The contents of the hidden figuration file are as follows
```{r}
batch_config_read(path)
```
The `time` value specifies the system time (in UTC) that the project was configured.
It is very important because only files that were last modified *before* the configuration time are considered to be unprocessed (when a file is successfully processed its modification time is automatically set to the current system time).

### Start

With the directory configured the next task is to start processing the files
```{r}
print(batch_run(path, ask = FALSE))
```

From the output we can see that 'file2.csv' was processed successfully but
processing of the other two files that matched regexp failed.
The output is also recorded in a hidden log file that can be read as follows
```{r}
batch_log_read(path)
```

At this point we can either update the fun using `batch_config_update()` 
or clean up the directory by deleting the hidden configuration and log files
and optionally the files that were or were not successfully processed.

```{r}
list.files(path)
print(batch_cleanup(path, force = TRUE, remaining = TRUE, failed = TRUE))
list.files(path)
```
